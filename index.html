<!DOCTYPE HTML>
<html>
    <head>
        <title>change</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!--  <script src="jquery1.82.js" ></script>-->
        <script src="mass.js" ></script>
        <style type="text/css">
            a {display:inline-block; margin-right:10px;}
            #clickHistory {border:1px solid #406c99; padding:15px; margin-top:10px; width:600px;}
        </style>
        <script>
         
            $.require("ready,event",function(){
                document.onclick = function(){
                    var t = Math.random();
                    location.hash = '#' + t;
                }
            
              
                if(window.parent == self){
                    function get_fragment (url) {
                        url = url || document.URL
                        // IE6直接用location.hash去hash是不安全的
                        // 比如 https://www.google.com.hk/reader/view/#stream/xxxxx?lang=zh_c
                        // ie6 => location.hash = #stream/xxxxx
                        // 其他浏览器 => location.hash = #stream/xxxxx?lang=zh_c
                        // 2.
                        // #!/home/q={%22thedate%22:%2220121010~20121010%22}
                        // firefox 15 => #!/home/q={"thedate":"20121010~20121010"}
                        return '#' + url.replace( /^[^#]*#?(.*)$/, '$1' );
                    }
                    var cur = get_fragment();
                    var div = document.createElement("div")
                    div.innerHTML =  '<iframe src="'+ location.href+'" width=400 height=200></iframe>'
                    document.body.appendChild(div)
                    var iframe = div.getElementsByTagName("iframe")[0].contentWindow
                    $.bind(iframe,"load",function(){
                        var doc = iframe.document
                        doc.open();
                        doc.write("<!doctype html><html><body>xxx</body></html>")
                        doc.close();
                    })
                    function setHash(iframe,  hash){
                        var doc = iframe.document
                        //                        doc.open();
                        //                        iframe.write("<!doctype html><html><body></body></html>")
                        //                        doc.close();
                        // var old = iframe.location 
                        // alert(location.href.replace( /#.*/, '' ) + hash)
                        iframe.location  = location.href.replace( /#.*/, '' ) + hash
                    }
                    
                    //   location.href.replace( /#.*/, '' ) + history_hash;
                    setInterval(function(){
                        var now =  get_fragment();
                        if(cur !== now){
                            setHash(iframe,now)
                            cur = now;
                            console.log(location.href)
                        }
                    },50)
                  
                }
    
                $(window).bind("hashchange",function(){
                    console.log(location.href)
                })
            })
            //   })
          
        </script>
    </head>
    <body >


        <p>但这个方案并不是实时触发的，而且究竟该多久检测一次，没有一个有依据的数值。如果数值过大，可能会影响到页面的快速呈现；如果数值过小，则会引起过高的资源占用。</p>
        <p>常用ajax的同学应该对onhashchange并不陌生，ajax并不是一个完美的东西，无刷新的页面会导致我们丢失本该有的浏览器历史记录，通常我们需要通过url hash来手动的产生浏览器历史记录，从而使“后退”/“前进”按钮有效。所以，还没有关注这点的同学也需要注意onhashchange了，有“后退”/“前进”功能的页面才是一个好页面。</p>
        <p>遗憾的是onhashchange事件是html5里新增加的，所以一些古老的浏览器并不支持它，目前的支持情况如下(<a href="http://blog.gslin.org/archives/2011/03/05/2491/window-%E7%9A%84-hashchange-onhashchange-%E4%BA%8B%E4%BB%B6" target="_blank">via</a>)：</p>
        <ul>
            <li>IE 的部份，IE8 之后才有支持：「<a href="http://msdn.microsoft.com/en-us/library/cc288209%28VS.85%29.aspx" target="_blank">onhashchange Event</a>」</li>
            <li>Firefox 則是 3.6 之后才有支持：「<a href="https://developer.mozilla.org/en/DOM/window.onhashchange" target="_blank">window.onhashchange</a>」</li>
            <li>Webkit 是 528 版以后 (2009/08/07 的 ticket)：「<a href="https://bugs.webkit.org/show_bug.cgi?id=21605" target="_blank">Support for HTML5 “hashchange” event</a>」，对应的版本是 <a href="http://www.google.com/chrome" target="_blank">Google Chrome</a> 1.0.154 之后，以及 <a href="http://www.apple.com/safari/" target="_blank">Safari</a> 4.0+。</li>
        </ul>
        <p>对于不支持的浏览器，可以使用隐藏的iframe来达到更改浏览器历史记录的目的。<br />
    </body>
</html>