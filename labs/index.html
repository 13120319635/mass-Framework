<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>mass Framework</title>


        <script type="text/javascript" src="../src/mass.js" charset="UTF-8"></script>
        <script type="text/javascript" src="ko.js" charset="UTF-8"></script>

        <script>

        </script>

    </head>
    <body>
    <style>
        .compare{
            border:1px solid #000;
            border-collapse:collapse;
        }
        .compare td{
            border:1px solid #000;
            width:30px;
            height:30px;
            text-align:center;
            background:olive;
        }
        td.zero{
            background:teal;
        }
        td.retain{
            background:orange;
        }
        td.update{
            background:fuchsia;
        }
        td.delete{
            background:red;
        }
        td.add{
            background:lime;
        }
    </style>
    <script type="text/javascript">


        /*    $.require("ready,more/avalon",function(){
            var mode = {
                people: $.observableArray([
                    { firstName: 'Bert', lastName: 'Bertington' },
                    { firstName: 'Charles', lastName: 'Charlesforth' },
                    { firstName: 'Denise', lastName: 'Dentiste' }
                ])
            }
            $.applyBindings(mode);
            setTimeout(function(){
                console.log("+++++++++++++++++++++++")
                mode.people.push({
                    firstName: 'XXX', lastName: 'CCC'
                });
                console.log(typeof mode.people.list[0])
            },1000)

        });*/
        //我们只需要三种操作,从旧组数取得retain类型的元素,从新数组取得update与add类型的元素
        var cur, ID = 1;
        var registry = {}
        var dependent = {}
        var detect = {
            begin: function( field ){
                var uuid = detect.register( field )
                if( cur ){
                    cur[uuid] = field
                }
                //用于收集依赖
                var prev = cur;
                cur = dependent[uuid];
                cur.prev = prev
            },
            register: function( field ){
                var uuid = field.observableID
                if(!uuid || !registry[uuid] ){
                    field.observableID  = uuid = "observable" +(++ID);
                    registry[uuid] = field;//供发布者使用
                    dependent[uuid] = {};//收集依赖
                    field.list = []
                    field.ensure = function(d){
                        if(field.list.indexOf(d) == -1){
                            field.list.push(d);
                        }
                    }
                }
                return uuid;
            },
            add: function( field ){
                if(cur){
                    var uuid = detect.register( field )
                    cur[ uuid ] = field;
                }
            },
            end: function( field ){
                var deps = dependent[ field.observableID ] || {};
                cur = deps.prev;
                for(var key in deps){
                    if(deps.hasOwnProperty(key) && (key != "prev")){
                        var low = registry[key];
                        low.ensure(field)
                    }
                }
                console.log(deps)
            }
        }
        var a = function(){
            detect.add(a)
        }
        var b = function(){
            detect.add(b)
        }
        var c = function(){
            detect.begin(c)
            a();
            b();
            detect.end(c)
        }
        var d = function(){
            detect.begin(d)
            c();
            detect.end(d)
        }
        d()
        //  console.log(dependent)
     

    </script>
    <div>
        <table>
            <thead>
                <tr><th>First name</th><th>Last name</th></tr>
            </thead>
            <tbody data-bind="foreach: people">
                <tr>
                    <td data-bind="text: firstName">XXX</td>
                    <td data-bind="text: lastName">YYY</td>
                </tr>
            </tbody>
        </table>


    </table>
</div>
if(Array.isArray(root)){
root = []
root = e;
flag = 0;
}
root.push(d)
flag = 1






</body>
</html>
